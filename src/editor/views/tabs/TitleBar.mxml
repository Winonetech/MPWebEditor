<?xml version="1.0" encoding="utf-8"?>
<s:BorderContainer xmlns:fx="http://ns.adobe.com/mxml/2009" 
				   xmlns:s="library://ns.adobe.com/flex/spark" 
				   xmlns:mx="library://ns.adobe.com/flex/mx" 
				   xmlns:tabs="editor.views.tabs.*"
				   borderAlpha="0.6" 
				   width="{HG.width + 2}"
				   resize="HG_resizeHandler(event)"
				   height="30" backgroundAlpha="0">
	<fx:Declarations>
		<!-- 将非可视元素（例如服务、值对象）放在此处 -->
	</fx:Declarations>
	<s:states>
		<s:State name="normal"/>
		<s:State name="much"/>
	</s:states>
	<s:HGroup gap="5">
		<s:HGroup gap="5" id="HG">
			<tabs:TitleTab width="40" label="布局" layoutCloseVisible="false"/>
		</s:HGroup>
	<s:ComboBox id="comboBox" dataProvider="{dataArrs}" includeIn="much" change="combobox1_changeHandler(event)"
					skinClass="editor.skins.TitleBarComboboxSkin"/>
	</s:HGroup>
	<fx:Script>
		<![CDATA[
			import editor.core.MDConfig;
			import editor.core.MDProvider;
			import editor.core.MDVars;
			import editor.views.Debugger;
			import editor.vos.Sheet;
			
			import mx.collections.ArrayCollection;
			import mx.events.FlexEvent;
			import mx.events.ResizeEvent;
			import mx.states.OverrideBase;
			
			import spark.events.IndexChangeEvent;
			
			[Bindable]
			public var _selected:TitleTab;
			
			public function get selected():TitleTab
			{
				return _selected;
			}
			
			public function set selected(value:TitleTab):void
			{
				var temp:Sheet = tab2Sheet(value);
				if (temp)
				{
					MDConfig.instance.editingSheet  = temp;
					_selected = value;
					updateBackgroundColor();
				}
			}
			
			[Bindable]
			public var dataArrs:ArrayCollection = new ArrayCollection; 
			public var idObj:Object = {};
			
			public function sheet2Tab($sheet:Sheet):TitleTab
			{
				var temp:TitleTab;
				for (var i:int; i < HG.numElements; i++)
				{
					temp = HG.getElementAt(i) as TitleTab	
					if ($sheet.id == idObj[temp])
					{
						return temp; 
					}
				}
				return null;
			}
			
			public function tab2Sheet($tab:TitleTab):Sheet
			{
				return MDProvider.instance.program.sheets[idObj[$tab]];
			}
			
			public function updateBackgroundColor():void
			{
				var temp:TitleTab;
				for (var i:int; i < HG.numElements; i++)
				{
					temp = HG.getElementAt(i) as TitleTab;
					if (idObj[temp] != idObj[selected])
					{
						temp.button.visible = false;
						temp.setStyle("backgroundColor", 0xffffff);
					}
					else
					{
						temp.button.visible = true;
						temp.setStyle("backgroundColor", 0);
					}
				}
			}
			
			protected function combobox1_changeHandler(event:IndexChangeEvent):void
			{
				MDConfig.instance.selectedSheet = null;
				var temp:TitleTab = comboBox.selectedItem as TitleTab;
				while (temp.width + width > MDVars.instance.editorView.canvas.width - 50)
				{
					var removed:TitleTab = HG.removeElementAt(HG.numElements - 1) as TitleTab;
					width -= removed.width;
					dataArrs.addItem(removed); 
				}
				HG.addElement(temp);
				dataArrs.removeItemAt(comboBox.selectedIndex);
				selected = temp;
			}
			
			private var oldWidth:Number;
			private var count:int;
			public var state:String;
//			protected function hgroup1_resizeHandler(event:ResizeEvent):void
//			{
//				if (state == "close") closed();
//				else
//				{
//					if (count > 1 && count & 1 == 1)
//					{
//						opened();
//					}
//					else oldWidth = event.oldWidth;
//					
//					count++;
//				}
//				if (dataArrs.length == 0) currentState = "normal";
//			}
			
			private function closed():void
			{
				Debugger.log("closed closed closed");
				if (dataArrs.length != 0)
				{
					for (var i:int; i < dataArrs.length; i++)
					{
						if (dataArrs[i].width + width < MDVars.instance.editorView.canvas.width - 50)
						{
							var temp:TitleTab = HG.addElement(dataArrs[i]) as TitleTab;
							dataArrs.removeItemAt(i);
							updateBackgroundColor();
						}
					}
				}
			}
			
			private function opened():void
			{
				Debugger.log("opened opened opened opened");
				while (width > MDVars.instance.editorView.canvas.width - 50)
				{
					currentState = "much";
 					width -= (HG.getElementAt(HG.numElements - 2) as TitleTab).width;
					dataArrs.addItem(HG.getElementAt(HG.numElements - 2) as TitleTab);
					HG.removeElementAt(HG.numElements - 2);
				}
			}
			
			protected function HG_resizeHandler(event:ResizeEvent):void
			{
				if (state == "close") closed();
				else
				{
					if (count > 1 && count & 1 == 1)
					{
						opened();
					}
					else oldWidth = event.oldWidth;
					
					count++;
				}
				if (dataArrs.length == 0) currentState = "normal";
			}
			
		]]>
	</fx:Script>
	
</s:BorderContainer>
